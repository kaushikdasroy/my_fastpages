<h1 id="inference-using-fine-tuned-ai-model-and-nvidia-triton-server">Inference using Fine-tuned AI Model and NVIDIA Triton Server</h1>

<p>Let’s start clara back up again.</p>

<p><img src="/images/test/image1.png" style="width:6.5in;height:2.20833in" /></p>

<p>Deployed kubernetes pods</p>

<p><img src="/images/test/image2.png" style="width:6.5in;height:1.15278in" /></p>

<h2 id="setting-up-triton-inference-server-to-host-our-model">Setting up TRITON inference server to host our model</h2>

<p>Create a folder structure as below</p>

<p><img src="/images/test/image3.png" style="width:6.5in;height:0.27778in" /></p>

<p>Move the refined model we created before to this directory.</p>

<p><img src="/images/test/image4.png" style="width:6.5in;height:0.19444in" /></p>

<p>Refer: <a href="https://blog.uplandr.com/2021/09/02/Fine-tune-a-Chest-Xray-Classification-Model-using-NVIDIA-Clara-Train.html"><u>https://blog.uplandr.com/2021/09/02/Fine-tune-a-Chest-Xray-Classification-Model-using-NVIDIA-Clara-Train.html</u></a></p>

<p>Refer to this documentation to know about the directory structure: <a href="https://docs.nvidia.com/deeplearning/triton-inference-server/master-user-guide/"><u>https://docs.nvidia.com/deeplearning/triton-inference-server/master-user-guide/</u></a></p>

<p>Create a file as below:</p>

<p><img src="/images/test/image5.png" style="width:6.5in;height:8.66667in" /></p>

<p>Create another file with our labels</p>

<p><img src="/images/test/image6.png" style="width:6.5in;height:7.84722in" /></p>

<h2 id="create-a-clara-deploy-operator">Create a Clara Deploy Operator</h2>

<p>We will create a clara deploy operator. This operator will be running in a container independent of clara deploy and the operator can be made part of a deployment pipeline.</p>

<p>Steps are given in here - <a href="https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference"><u>https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference</u></a></p>

<p>We need to grab these-</p>

<ul>
  <li>
    <p>Clara deploy base inference operator</p>
  </li>
  <li>
    <p>Clara chest classification operator</p>
  </li>
  <li>
    <p>TRITIS (Triton) container</p>
  </li>
</ul>

<p>Make sure you have your ngc connection or else rebuild connection to ngc with docker login nvcr.io</p>

<p><img src="/images/test/image7.png" style="width:6.5in;height:2.625in" /></p>

<p><img src="/images/test/image8.png" style="width:6.5in;height:2.70833in" /></p>

<p><img src="/images/test/image9.png" style="width:6.5in;height:3.45833in" /></p>

<p>Retag the docker image as latest</p>

<p><img src="/images/test/image10.png" style="width:6.5in;height:0.18056in" /></p>

<p>Create a Operator directory structure</p>

<p><img src="/images/test/image11.png" style="width:6.5in;height:0.68056in" /></p>

<p>Run the chest xray operator docker container</p>

<p><img src="/images/test/image12.png" style="width:6.5in;height:0.18056in" /></p>

<p>Copy 2 files from the container</p>

<p><img src="/images/test/image13.png" style="width:6.5in;height:0.19444in" /></p>

<p><img src="/images/test/image14.png" style="width:6.5in;height:0.18056in" /></p>

<p>Exit from the container and change the owner for the files to your own. There are few changes to be made in these two files. Change the model to be used to “classification_covidxray_v1” from “classification_cheastxray_v1”. And in the config_inference change the `subtrahend` and `divisor` to 128.</p>

<p><img src="/images/test/image15.png" style="width:6.5in;height:0.625in" /></p>

<p>Create a Dockerfile with base as app_base_inference and copy the config files taken from the chestxray</p>

<p><img src="/images/test/image16.png" style="width:6.5in;height:6.98611in" /></p>

<h2 id="test-the-custom-operator">Test the custom operator</h2>

<p>We will run the operator outside of clara deploy pipeline using docker and a script.</p>

<p>Copy the script from the “executing with docker” section of the link - <a href="https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference"><u>https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference</u></a></p>

<p>Change the script as follows to make it suitable for our purpose.</p>

<p>Create a file</p>

<p>vi /etc/clara/operators/run_covid_docker.sh</p>

<p>Open the file run_covid_docker.sh and paste the script from “executing with docker” section of the link - <a href="https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference"><u>https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference</u></a></p>

<p>Need to make following edits:</p>

<p>Replace APP_NAME with “app_covidxray”</p>

<p>Replace MODEL_NAME with “classification_covidxray_v1”.</p>

<p>The line that starts with nvidia-docker — replace $(pwd) with clara/common (so this part reads -v /clara/common/models/${MODEL_NAME}:/models/${MODEL_NAME}</p>

<p>In the line “-v $(pwd)/input:/input \”, replace $(pwd) with “/etc/clara/operators/app_covidxray”</p>

<p>In the line “-v $(pwd)/output:/output \”, replace $(pwd) with “/etc/clara/operators/app_covidxray”</p>

<p>In the line “-v $(pwd)/logs:/logs \”, replace $(pwd) with “/etc/clara/operators/app_covidxray”</p>

<p>In the line “-v $(pwd)/publish:/publish \”, replace $(pwd) with “/etc/clara/operators/app_covidxray”</p>

<p>Comment the lines as indicated in notes of the file if using NGC containers for testing.</p>

<p>Save and exit from the file.</p>

<p>Copy one image in our test input folder.</p>

<p>cp /etc/clara/experiments/covid-training-set/training-images/1-s2.0-S0929664620300449-gr2_lrg-b.png /etc/clara/operators/app_covidxray/input</p>

<p>Change permission of the script file and run the script</p>

<p>chmod 700 /etc/clara/operators/run_covid_docker.sh</p>

<p>cd /etc/clara/operators/</p>

<p><img src="/images/test/image17.png" style="width:6.5in;height:0.23611in" /></p>

<p>To check the job was successful, check the output folder for a file with the inference</p>

<p><img src="/images/test/image18.png" style="width:6.5in;height:0.20833in" /></p>

<p>Check the output folder and display the image with labels and categories and % of chance</p>

<p><img src="/images/test/image19.png" style="width:6.5in;height:0.45833in" /></p>

<p>Output with inference shown in the picture!</p>

<p><img src="/images/test/image20.png" style="width:6.5in;height:5.19444in" /></p>

<h2 id="create-a-clara-deploy-pipeline-for-inference">Create a Clara Deploy Pipeline for inference</h2>

<p>Create a clean docker build using the Dockerfile</p>

<p><img src="/images/test/image21.png" style="width:6.5in;height:1.79167in" /></p>

<p>The steps are described here - <a href="https://docs.nvidia.com/clara/deploy/sdk/Applications/Pipelines/ChestxrayPipeline/public/docs/README.html"><u>https://docs.nvidia.com/clara/deploy/sdk/Applications/Pipelines/ChestxrayPipeline/public/docs/README.html</u></a></p>

<p><a href="https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference"><u>https://ngc.nvidia.com/catalog/containers/nvidia:clara:app_base_inference</u></a></p>

<p>Start with a chest xray classification pipeline and change it to fit covid xray pipeline</p>

<p><img src="/images/test/image22.png" style="width:6.5in;height:0.19444in" /></p>

<p><img src="/images/test/image23.png" style="width:6.5in;height:0.19444in" /></p>

<p>Make some changes covidxray-pipeline.yaml file to fit it for our purpose</p>

<p>Change the container image to - app_covidxray, and tag to latest</p>

<p>Remove the pull secrets part</p>

<p>Change all reference of chest xray to covid xray</p>

<p>Note: Make sure the triton server version is appropriate. Pay attention to app_base_inference version, reference pipeline version (in this case clara_ai_chestxray_pipeline) and triton server version. All these need to be in sync for the inference to work.</p>

<p>For the current example I am using app_base_inference ( not app_base_inference_v2 ) and I used nvcr.io/nvidia/tensorrtserver tag 19.08-py3 (rather than tritonserver). Change the “Command” to “trtserver” if using tensorrtserver.</p>

<p>Save and exit</p>

<p>Now we are ready to create our covid xray pipeline</p>

<p><img src="/images/test/image24.png" style="width:6.5in;height:0.38889in" /></p>

<p>This will give you a pipeline id.</p>

<h2 id="run-test-image-through-the-pipeline">Run test image through the pipeline</h2>

<p>Now use the created pipeline to process one image from the input file.</p>

<p><img src="/images/test/image25.png" style="width:6.5in;height:0.44444in" /></p>

<p>Manually start the job</p>

<p><img src="/images/test/image26.png" style="width:6.5in;height:0.44444in" /></p>

<p>The completed pipeline view in Clara console (port 32002)</p>

<p><img src="/images/test/image27.png" style="width:6.5in;height:1.63889in" /></p>

<p><img src="/images/test/image28.png" style="width:6.5in;height:3.91667in" /></p>

<p>Output after download</p>

<p><img src="/images/test/image29.png" style="width:5.46875in;height:5.5in" /></p>

<p>Here you have it, your own model is used in inference through triton server and clara pipeline!</p>
